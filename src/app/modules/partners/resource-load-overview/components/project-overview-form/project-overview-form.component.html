<mat-card class="card-container">
  <mat-card-header>
    <mat-card-title>{{ 'PROJECTS_GANT_OVERVIEW.FORM.TITLE' | translate }}</mat-card-title>
    <mat-card-subtitle>{{ 'PROJECTS_GANT_OVERVIEW.FORM.SUBTITLE' | translate }}</mat-card-subtitle>
  </mat-card-header>

  <mat-card-content class="row sticky" style="overflow-x: auto;">
    <form [formGroup]="form" style="margin-top: 0.3rem;">
      <mat-form-field assistance="fill" formGroupName="unit" check-visibility control="unit.id">
        <mat-label>{{ "RESOURCES.FIELDS.UNIT" | translate }}</mat-label>
        <mat-select formControlName="id" (selectionChange)="onUnitChange($event.value)">
          <mat-option [value]="0" [disabled]="!permissions">All</mat-option>
          <mat-option *ngFor="let unit of units" [value]="unit.id" [disabled]="!permissions">
            {{ unit.trigram }}
          </mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field formGroupName="status" style="margin-left: 1rem;">
        <mat-label>{{ "RESOURCES.FIELDS.STATUS" | translate }}</mat-label>
        <mat-select formControlName="value" (selectionChange)="onStatusChange($event.value)" multiple>
          <mat-option #allOption [value]="''" [disabled]="!permissions || allOptionDisabled">All</mat-option>
          <ng-template ngFor let-status [ngForOf]="ProjectStatus | keyvalue">
            <mat-option [value]="status.value" [disabled]="!permissions || allOptionSelected">
              {{ status.value }}
            </mat-option>
          </ng-template>
        </mat-select>
      </mat-form-field>
      

      <i class="fa-solid fa-spinner in-progress-icon fa-2xl icon-left" style="margin-left: 7px;"></i> In Progress
      <i class="fa-regular fa-circle presale-icon fa-2xl icon-left" style="margin-left: 7px;"></i> Pre-Sale
      <i class="fa-regular fa-circle-play fa-2xl to-start-icon icon-left" style="margin-left: 7px;"></i> To Start
      <i class="fa-regular fa-circle-check fa-2xl cancelled-icon icon-left" style="margin-left: 7px;"></i> Cancelled
      <i class="fa-regular fa-circle-xmark fa-2xl completed-icon icon-left" style="margin-left: 7px;"></i> Closed
      <i class="fa-solid fa-ban fa-2xl icon-left" style="margin-left: 7px;"></i> Lost
    </form>
  </mat-card-content>

  <hr class="w-100">

  <div class="table-scroll">
    <div class="spinner-container" *ngIf="isLoading">
      <div class="spinner">
        <mat-spinner diameter="80"></mat-spinner>
      </div>
    </div>

    <ng-container *ngIf="!isLoading">

      <div class="table-project-container mat-elevation-z8" #tableResourses>
        <table mat-table [dataSource]="projectsLoad" class="mat-elevation-z8">

          <ng-container matColumnDef="unitTrigram" [sticky]="true">
            <th mat-header-cell *matHeaderCellDef>Unit</th>
            <td mat-cell *matCellDef="let projectLoad; let i = index;" [attr.rowspan]="2"
              [style.display]="(i%2 === 0)? '' : 'none'">
              {{projectLoad.unitTrigram}}
            </td>
          </ng-container>

          <ng-container matColumnDef="status" [sticky]="true">
            <th mat-header-cell *matHeaderCellDef>Status</th>
            <td mat-cell *matCellDef="let projectLoad; let i = index;" [attr.rowspan]="2"
              [style.display]="(i%2 === 0)? '' : 'none'">
              <i *ngIf="projectLoad.status === 'In Progress'" class="fa-solid fa-spinner in-progress-icon fa-2xl"
                #tooltip="matTooltip" matTooltip="{{ projectLoad.status}}" matTooltipPosition="above"></i>
              <i *ngIf="projectLoad.status === 'Pre-Sale'" class="fa-regular fa-circle presale-icon fa-2xl"
                #tooltip="matTooltip" matTooltip="{{ projectLoad.status}}" matTooltipPosition="above"></i>
              <i *ngIf="projectLoad.status === 'To Start'" class="fa-regular fa-circle-play fa-2xl to-start-icon"
                #tooltip="matTooltip" matTooltip="{{ projectLoad.status}}" matTooltipPosition="above"></i>
              <i *ngIf="projectLoad.status === 'Cancelled'" class="fa-regular fa-circle-check fa-2xl cancelled-icon"
                #tooltip="matTooltip" matTooltip="{{ projectLoad.status}}" matTooltipPosition="above"></i>
              <i *ngIf="projectLoad.status === 'Closed'" class="fa-regular fa-circle-xmark fa-2xl completed-icon"
                #tooltip="matTooltip" matTooltip="{{ projectLoad.status}}" matTooltipPosition="above"></i>
              <i *ngIf="projectLoad.status === 'Lost'" class="fa-solid fa-ban fa-2xl" #tooltip="matTooltip"
                matTooltip="{{ projectLoad.status}}" matTooltipPosition="above"></i>
            </td>
          </ng-container>

          <ng-container matColumnDef="name" [sticky]="true">
            <th mat-header-cell *matHeaderCellDef>Project name</th>
            <td mat-cell *matCellDef="let projectLoad; let i = index;" [attr.rowspan]="2"
              [style.display]="(i%2 === 0)? '' : 'none'">
              {{projectLoad.name}}
            </td>
          </ng-container>

          <ng-container matColumnDef="cw" [sticky]="true">
            <th mat-header-cell *matHeaderCellDef>CW</th>
            <td mat-cell *matCellDef="let projectLoad" #tooltip="matTooltip"
              matTooltip="{{projectLoad.cw === 'AC' ? 'HR Actual Cost' : 'HR Estimated Cost' }}"
              matTooltipClass="custom-tooltip" matTooltipPosition="above"> {{projectLoad.cw}} </td>
          </ng-container>

          <ng-container *ngFor="let month of months" matColumnDef="{{month.name}}">
            <th class="text-center" mat-header-cell *matHeaderCellDef>
              <div class="d-flex justify-content-around p-1">
                <p *ngFor="let week of month.weeks" style="width: 45px;">
                  {{week}}
                </p>
              </div>
            </th>
            <td mat-cell *matCellDef="let projectLoad; let isOdd = odd">
              <ng-container *ngIf="!isOdd">
                <div class="d-flex justify-content-start p-1"
                  [ngClass]="{
                    'small-month' : getObjectKeys(projectLoad.estimatedCostPct, month.index).length <= 4,
                    'float-left' : getObjectKeys(projectLoad.estimatedCostPct, month.index).length === 1 || getObjectKeys(projectLoad.estimatedCostPct, month.index).length === 2 || getObjectKeys(projectLoad.estimatedCostPct, month.index).length === 3
                  }">
                  <div *ngFor="let week of getObjectKeys(projectLoad.estimatedCostPct, month.index)" #tooltip="matTooltip"
                    matTooltip="{{ projectLoad.estimatedCost[month.index][week]}} € " matTooltipPosition="above"
                    align="center" class="sales-commitment" style="background-color: rgb(126, 211, 253);">
                    {{ projectLoad.estimatedCostPct[month.index][week] }}%
                    <!--interpolazione per testare se l'associazione mese settimana sia corretta-->
                    <!--{{month.index}},{{week}}-->
                  </div>
                </div>
              </ng-container>
              <ng-container *ngIf="isOdd">
                <div class="d-flex justify-content-start p-1"
                  [ngClass]="{
                  'small-month' : getObjectKeys(projectLoad.actualCostPct, month.index).length <= 4,
                  'float-left' : getObjectKeys(projectLoad.actualCostPct, month.index).length === 1 || getObjectKeys(projectLoad.actualCostPct, month.index).length === 2 || getObjectKeys(projectLoad.actualCostPct, month.index).length === 3}">
                  <div *ngFor="let week of getObjectKeys(projectLoad.actualCostPct, month.index)" #tooltip="matTooltip"
                    matTooltip="{{ projectLoad.actualCost[month.index][week] }} €" matTooltipPosition="above"
                    align="center" class="real-commitment"
                    [ngClass]="(projectLoad.actualCost[month.index]?.[week] !== undefined && projectLoad.estimatedCost[month.index]?.[week] !== undefined) ? (projectLoad.actualCost[month.index][week] <= projectLoad.estimatedCost[month.index][week] ? 'bg-success' : 'bg-danger') : ''">
                    {{ projectLoad.actualCostPct[month.index][week] }}%
                    <!--interpolazione per testare se l'associazione mese settimana sia corretta-->
                    <!--{{month.index}},{{week}}-->
                  </div>
                </div>
              </ng-container>
            </td>
          </ng-container>

          <!-- START Header first row -->
          <ng-container matColumnDef="header-empty-group-first" [sticky]="true">
            <th mat-header-cell *matHeaderCellDef [style.text-align]="'center'" [attr.colspan]="4">
            </th>
          </ng-container>

          <ng-container *ngFor="let month of months" matColumnDef="{{month.name}}-header">
            <th class="text-center" mat-header-cell *matHeaderCellDef
              [ngClass]="{ 'current-month': month.isCurrentMonth, 'other-month': !month.isCurrentMonth }">
              {{ month.name }} {{ currentYear }}</th>
          </ng-container>
          <!-- END Header first row -->

          <tr mat-header-row *matHeaderRowDef="firstHeaderRow; sticky: true;"></tr>
          <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: true;"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns; let odd = odd; let even = even; let i = index;"
          [ngClass]="{'odd-row': !isOddRowReverse(i)}"></tr>
        </table>
      </div>
    </ng-container>

    <mat-paginator [pageSize]="pageable.size" [length]="totalElements" (page)="onPageChange($event)"
      showFirstLastButtons></mat-paginator>
  </div>
</mat-card>

<ng-template #spinnerContent>
  <div class="spinner-container">
    <mat-spinner diameter="50"></mat-spinner>
  </div>
</ng-template>